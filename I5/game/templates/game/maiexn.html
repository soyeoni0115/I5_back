{% block content %}
<div class="game-container" style="text-align: center; margin-top: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">

    <div id="screen-lobby">
        <h1>ğŸ® ë‹¨ì–´ í€´ì¦ˆ ê²Œì„</h1>
        <p>30ì´ˆ ë™ì•ˆ ìµœëŒ€í•œ ë§ì€ ë‹¨ì–´ë¥¼ ë§ì¶°ë³´ì„¸ìš”!</p>

        <div style="margin: 30px 0; padding: 20px; background-color: #f9f9f9; border-radius: 10px;">
            {% if user.is_authenticated %}
                <h3>í™˜ì˜í•©ë‹ˆë‹¤, <strong>{{ user.username }}</strong>ë‹˜!</h3>
                <button onclick="startGame()" style="padding: 15px 40px; font-size: 1.2em; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    ê²Œì„ ì‹œì‘
                </button>
            {% else %}
                <h3>Guest ëª¨ë“œ</h3>
                <input type="text" id="guest-nickname" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" style="padding: 10px; width: 200px;">
                <button onclick="startGame()" style="padding: 10px 20px; cursor: pointer; background-color: #2196F3; color: white; border: none; border-radius: 5px;">
                    ê²Œì„ ì‹œì‘
                </button>
            {% endif %}
        </div>

        <h3>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹ (Top 10)</h3>
        <table border="1" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead style="background-color: #eee;">
                <tr>
                    <th>ìˆœìœ„</th>
                    <th>í”Œë ˆì´ì–´</th>
                    <th>ì ìˆ˜</th>
                    <th>ë‚ ì§œ</th>
                </tr>
            </thead>
            <tbody>
                {% for record in leaderboard %}
                <tr>
                    <td>{{ record.rank_val }}ìœ„</td> 
                    <td>{{ record.player_name }}</td>
                    <td>{{ record.score }}ì </td>
                    <td>{{ record.date|date:"Y-m-d" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4">ì•„ì§ ë“±ë¡ëœ ë­í‚¹ì´ ì—†ìŠµë‹ˆë‹¤. 1ë“±ì„ ë…¸ë ¤ë³´ì„¸ìš”!</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="screen-game" style="display: none;">
        <div style="display: flex; justify-content: space-between; width: 80%; margin: 0 auto; font-weight: bold; font-size: 1.2em;">
            <span id="timer-display" style="color: #d9534f;">ë‚¨ì€ ì‹œê°„: 30ì´ˆ</span>
            <span id="score-display" style="color: #0275d8;">ì ìˆ˜: 0</span>
        </div>

        <h2 id="question-word" style="margin: 40px 0; font-size: 2.5em; color: #333;">Loading...</h2>
        
        <div id="options-area" style="display: flex; flex-direction: column; gap: 10px; max-width: 400px; margin: 0 auto;">
            </div>

        <p id="feedback-msg" style="height: 20px; font-weight: bold; margin-top: 20px; font-size: 1.2em;"></p>
    </div>

</div>

<script>
    // Django URLì„ ìë°”ìŠ¤í¬ë¦½íŠ¸ ë³€ìˆ˜ë¡œ ì €ì¥ (í•˜ë“œì½”ë”© ë°©ì§€)
    const URLS = {
        start: "{% url 'game:start_game' %}",
        getQuiz: "{% url 'game:get_quiz' %}",
        check: "{% url 'game:check_answer' %}",
        result: "{% url 'game:game_result' %}"
    };

    let state = {
        gameId: null,
        wordId: null,
        timeLeft: 30,
        timer: null
    };

    // ì¿ í‚¤ì—ì„œ CSRF í† í° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // 1. ê²Œì„ ì‹œì‘ í•¨ìˆ˜
    async function startGame() {
        const nicknameInput = document.getElementById('guest-nickname');
        // ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ null (ë°±ì—”ë“œê°€ ì•Œì•„ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ ë¡œê·¸ì¸ ìœ ì €ëŠ” ë¬´ì‹œ)
        const nickname = nicknameInput ? nicknameInput.value : "";
        
        try {
            const csrftoken = getCookie('csrftoken');
            const res = await fetch(URLS.start, { // ìˆ˜ì •ëœ URL ì‚¬ìš©
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken 
                },
                body: JSON.stringify({ nickname: nickname })
            });

            if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');

            const data = await res.json();
            state.gameId = data.game_id;
            
            // í™”ë©´ ì „í™˜: ë­í‚¹ ìˆ¨ê¸°ê¸° -> ê²Œì„ ë³´ì—¬ì£¼ê¸°
            document.getElementById('screen-lobby').style.display = 'none';
            document.getElementById('screen-game').style.display = 'block';
            
            loadQuiz();
            startTimer();
            
        } catch (err) {
            console.error("Start Error:", err);
            alert("ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // 2. ë¬¸ì œ ë¡œë“œ í•¨ìˆ˜
    async function loadQuiz() {
        try {
            const res = await fetch(URLS.getQuiz);
            const data = await res.json();

            if(data.error) throw new Error(data.error);

            state.wordId = data.word_id;
            document.getElementById('question-word').innerText = data.quiz_word;
            document.getElementById('feedback-msg').innerText = "";
            
            const area = document.getElementById('options-area');
            area.innerHTML = '';
            
            data.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.innerText = opt.text;
                btn.style.padding = "15px";
                btn.style.fontSize = "16px";
                btn.style.cursor = "pointer";
                btn.style.backgroundColor = "#fff";
                btn.style.border = "1px solid #ccc";
                
                // ë²„íŠ¼ í´ë¦­ ì‹œ ì •ë‹µ ì²´í¬
                btn.onclick = () => checkAnswer(opt.id, btn);
                area.appendChild(btn);
            });
        } catch (e) {
            console.error(e);
            // alert("ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // 3. ì •ë‹µ í™•ì¸ í•¨ìˆ˜
    async function checkAnswer(selectedId, btnElement) {
        // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        const area = document.getElementById('options-area');
        Array.from(area.children).forEach(b => b.disabled = true);

        const csrftoken = getCookie('csrftoken');
        
        const res = await fetch(URLS.check, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken 
            },
            body: JSON.stringify({
                game_id: state.gameId,
                word_id: state.wordId,
                selected_id: selectedId
            })
        });

        const data = await res.json();
        
        const msgBox = document.getElementById('feedback-msg');
        
        if (data.is_correct) {
            msgBox.innerText = "â­• ì •ë‹µ! (+10)";
            msgBox.style.color = "blue";
            btnElement.style.backgroundColor = "#d4edda"; // ì´ˆë¡ìƒ‰ ë°°ê²½
            document.getElementById('score-display').innerText = `ì ìˆ˜: ${data.current_score}`;
        } else {
            msgBox.innerText = "âŒ ì˜¤ë‹µ! ";
            msgBox.style.color = "red";
            btnElement.style.backgroundColor = "#f8d7da"; // ë¹¨ê°„ìƒ‰ ë°°ê²½
        }

        // 1ì´ˆ ë’¤ ë‹¤ìŒ ë¬¸ì œ (ì‹œê°„ ë‚¨ì•˜ì„ ë•Œë§Œ)
        if (state.timeLeft > 0) {
            setTimeout(loadQuiz, 1000); 
        }
    }

    // 4. íƒ€ì´ë¨¸ í•¨ìˆ˜
    function startTimer() {
        const timerDisplay = document.getElementById('timer-display');
        
        state.timer = setInterval(() => {
            state.timeLeft--;
            timerDisplay.innerText = `ë‚¨ì€ ì‹œê°„: ${state.timeLeft}ì´ˆ`;

            if (state.timeLeft <= 0) {
                clearInterval(state.timer);
                finishGame();
            }
        }, 1000);
    }

    // 5. ê²Œì„ ì¢…ë£Œ í•¨ìˆ˜
    function finishGame() {
        alert("ì‹œê°„ ì¢…ë£Œ! ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.");
        // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = `${URLS.result}?game_id=${state.gameId}`;
    }
</script>
{% endblock %}